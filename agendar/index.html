<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Contato</title>
    <link rel="stylesheet" href="../recursos/css/formulario.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.9.1/fonts/remixicon.min.css">

    <!-- Todo css do formuario está no arquivo "formulario.css"-->
    <style>
        /* Loader fullscreen */
        #loaderContainer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #loaderContainer.hide {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #4c78ddd7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        /* Estilos para erro */
        .loader-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loader-spinner.hidden {
            display: none;
        }

        .loader-error {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            text-align: center;
            max-width: 400px;
        }

        .loader-error.show {
            display: flex;
        }

        .loader-error-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .loader-error-message {
            font-size: 16px;
            color: #666;
            margin: 0;
            line-height: 1.5;
        }

        .btn-retry {
            padding: 12px 28px;
            background: white;
            color: #000;
            border: 1px solid #000;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-retry:hover {
            background: #f5f5f5;
        }

        .btn-retry:active {
            background: #efefef;
        }

        /* Estilos para Seleção de Datas */
        .datas-container {
            width: 100%;
            overflow: hidden;
            border-radius: 8px;
        }

        .datas-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .datas-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .datas-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .datas-scroll::-webkit-scrollbar-thumb {
            background: #d37c7cd7;
            border-radius: 10px;
        }

        .datas-scroll::-webkit-scrollbar-thumb:hover {
            background: #c56a6ad0;
        }

        .data-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 70px;
            padding: 12px 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            font-size: 14px;
        }

        .data-badge:hover {
            border-color: #d37c7cd7;
            background: #fff9f8;
        }

        .data-badge.selected {
            background: #d37c7cd7;
            border-color: #d37c7cd7;
            color: white;
        }

        .data-badge-dia {
            font-size: 11px;
            text-transform: uppercase;
            color: #999;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .data-badge.selected .data-badge-dia {
            color: white;
        }

        .data-badge-data {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .data-badge.selected .data-badge-data {
            color: white;
        }

        .data-badge-mes {
            font-size: 10px;
            text-transform: uppercase;
            color: #999;
            margin-top: 4px;
        }

        .data-badge.selected .data-badge-mes {
            color: white;
        }

        /* Estilos para Seleção de Horários */
        .horarios-container {
            width: 100%;
            overflow: hidden;
            border-radius: 8px;
        }

        .horarios-scroll {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            padding: 10px 0;
            width: 100%;
        }

        .horario-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            min-height: 48px;
        }

        .horario-badge:hover {
            border-color: #d37c7cd7;
            background: #fff9f8;
        }

        .horario-badge.selected {
            background: #d37c7cd7;
            border-color: #d37c7cd7;
            color: white;
        }

        .horario-badge:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Estilos para horários ocupados */
        .horario-badge.ocupado {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .horario-badge.ocupado::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #626262d7;
            transform: translateY(-50%);
        }

        .horario-badge.ocupado:hover {
            border-color: #e0e0e0;
            background: white;
        }

        /* Estilos para datas passadas */
        .data-badge.passada {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
            background: #f5f5f5 !important;
            border-color: #ddd !important;
            pointer-events: none;
        }

        .data-badge.passada .data-badge-data {
            color: #999;
        }

        .data-badge.passada:hover {
            border-color: #ddd !important;
            background: #f5f5f5 !important;
        }
    </style>
</head>

<body>
    <!-- Loader -->
    <div id="loaderContainer">
        <div class="loader-content">
            <div class="loader-spinner">
                <div class="spinner"></div>
                <p class="loader-text">Um momento, por favor...</p>
            </div>
            <div class="loader-error">
                <h2 class="loader-error-title">Temporariamente fora de sistema.</h2>
                <p class="loader-error-message">Parece que o servidor está em um mau dia ou passando por manutenção.
                    Tente novamente ou volte mais tarde. (503)</p>
                <a href="../#contato">Fale conosco</a>
                <button type="button" class="btn-retry" id="btnRetry">Tentar novamente</button>
            </div>
        </div>
    </div>

    <header>
        <nav role="navigation" aria-label="Menu principal">
            <div class="nav-container">
                <div class="nav-left">
                    <img src="../recursos/imgs/img1.webp" alt="Logo da Clínica" class="nav-logo">
                    <h2 class="nav-clinica-nome" style="font-weight: 400; color: #d37c7cd7; font-size: 19px;">Odonto
                        Clínica
                    </h2>
                </div>

                <button class="nav-toggle" aria-expanded="false" aria-controls="main-nav" aria-label="Abrir menu">
                    <svg width="28" height="24" viewBox="0 0 28 24" aria-hidden="true" focusable="false">
                        <path class="line line-top" d="M3 5h22" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round"></path>
                        <path class="line line-mid" d="M3 12h22" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round"></path>
                        <path class="line line-bot" d="M3 19h22" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round"></path>
                    </svg>
                </button>

                <ul class="nav-links" id="main-nav">
                    <li><a href="../">Início</a></li>
                    <li><a href="../#servicos">Serviços</a></li>
                    <li><a href="#">Agendamento</a></li>
                    <li><a href="../#contato">Contato</a></li>
                </ul>
            </div>
        </nav>

        <!-- Overlay para fechar o menu e escurecer o fundo em mobile (fora da nav para não sobrepor) -->

        <div id="listaAgendamentos">
            <h3>
                <span>Meus Agendamentos </span>
                <button type="button" class="btn-fechar-modal" id="btnFecharModal">&times;</button>
            </h3>
            <div id="agendamentosConteudo">
                — Nenhum agendamento carregado —
            </div>
        </div>
    </header>

    <button type="button" id="verAgendamentos"><i class="ri-eye-line"></i> Ver meus agendamentos</button>

    <!-- Overlay para modal -->
    <div id="overlay" class="modal-overlay"></div>

    <!-- Overlay para o menu de navegação mobile -->
    <div id="nav-overlay" class="nav-overlay"></div>

    <form id="formularioAgendamento">
        <img src="../recursos/imgs/img0.webp" alt="" style="width: 270px; display: block; margin: 20px auto;">
        <h2 style="text-align: center; font-weight: 400; color: #303030;">Faça seu agendamento</h2>
        <p
            style=" text-align: center; font-size: 13px; margin-bottom: 15px; margin-top: -10px; color: rgb(63, 63, 63);">
            Seja bem-vindo à Odonto Clínica! Preencha os dados abaixo para agendar seu horário.</p>

        <div>
            <label for="nome">Nome:</label>
            <input type="text" id="nome" required placeholder="Ex. João Marcos">
        </div>

        <div>
            <label for="telefone">Telefone:</label>
            <p> </p>
            <div class="telefone-container">
                <span class="telefone-prefixo">(81) 9</span>
                <input type="tel" id="telefone" required placeholder="XXXX-XXXX" maxlength="9" inputmode="numeric">
            </div>
        </div>

        <div>
            <label for="servico">Serviço:</label>
            <div class="dropdown-container" id="dropdownServico">
                <button type="button" class="dropdown-toggle" id="dropdownToggle" aria-haspopup="listbox"
                    aria-expanded="false">
                    <span class="dropdown-label">Selecione um serviço</span>
                    <svg class="dropdown-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <ul class="dropdown-menu" id="dropdownMenu" role="listbox">
                    <li class="dropdown-option" data-value="" data-label="Selecione um serviço">Selecione um serviço
                    </li>
                    <li class="dropdown-option" data-value="Limpeza" data-label="Limpeza">Limpeza</li>
                    <li class="dropdown-option" data-value="Branqueamento" data-label="Branqueamento">Branqueamento</li>
                    <li class="dropdown-option" data-value="Restauração" data-label="Restauração">Restauração</li>
                    <li class="dropdown-option" data-value="Implante" data-label="Implante">Implante</li>
                    <li class="dropdown-option" data-value="Extração" data-label="Extração">Extração</li>
                    <li class="dropdown-option" data-value="Tratamento de Canal" data-label="Tratamento de Canal">
                        Tratamento de Canal</li>
                    <li class="dropdown-option" data-value="Aparelho" data-label="Aparelho">Aparelho</li>
                    <li class="dropdown-option" data-value="Consulta" data-label="Consulta">Consulta</li>
                </ul>
            </div>
            <input type="hidden" id="servico" name="servico" required>
        </div>

        <div>
            <label for="dataAgendamento">Data:</label>
            <div class="datas-container" id="datasContainer">
                <div class="datas-scroll" id="datasScroll">
                    <!-- Badges de datas serão adicionadas aqui via JavaScript -->
                </div>
            </div>
            <input type="hidden" id="dataAgendamento" name="dataAgendamento" required>
        </div>

        <div>
            <label for="horarioAgendamento">Horário:</label>
            <p style="font-size: 12px; margin-top: -6px; margin-bottom: 8px; color: #606060;">* Confira se o tempo do
                serviço cabe no horário que foi selecionado para agendamento. Se não for possível agendar nessa data,
                tente buscar outras datas disponíveis.
                <br> Tem dúvidas? <a href="../#contato" style="">Fale conosco</a>.
            </p>
            <div class="horarios-container" id="horariosContainer">
                <div class="horarios-scroll" id="horariosScroll">
                    <!-- Badges de horários serão adicionados aqui via JavaScript -->
                </div>
            </div>
            <input type="hidden" id="horarioAgendamento" name="horarioAgendamento" required>
        </div>

        <button type="submit" id="btnAgendar">
            <span class="spinner-loader"></span>
            <span class="btn-text">AGENDAR</span>
        </button>
    </form>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../recursos/js/supabase.js"></script>

    <script>
        // DROPDOWN CUSTOMIZADO UNIVERSAL
        class CustomDropdown {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.toggle = this.container.querySelector('.dropdown-toggle');
                this.menu = this.container.querySelector('.dropdown-menu');
                this.options = this.container.querySelectorAll('.dropdown-option');
                this.hiddenInput = document.getElementById('servico');
                this.currentValue = '';
                this.currentLabel = 'Selecione um serviço';
                this.init();
            }

            init() {
                this.toggle.addEventListener('click', () => this.toggleMenu());
                this.options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        if (!option.classList.contains('disabled')) {
                            this.selectOption(option);
                        }
                        e.preventDefault();
                    });
                    option.addEventListener('keydown', (e) => this.handleKeydown(e, option));
                });

                document.addEventListener('click', (e) => this.handleClickOutside(e));
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.menu.classList.contains('open')) {
                        this.closeMenu();
                        this.toggle.focus();
                    }
                });

                this.toggle.addEventListener('keydown', (e) => this.handleToggleKeydown(e));
            }

            toggleMenu() {
                if (this.menu.classList.contains('open')) {
                    this.closeMenu();
                } else {
                    this.openMenu();
                }
            }

            openMenu() {
                this.menu.classList.add('open');
                this.toggle.setAttribute('aria-expanded', 'true');

                // Reseta o scroll da lista para o topo
                this.menu.scrollTop = 0;

                // Scroll suave para posição confortável de visualização
                this.scrollToComfortablePosition();

                // Foca na primeira opção ou na selecionada
                const selectedOption = this.menu.querySelector('[aria-selected="true"]');
                if (selectedOption) {
                    selectedOption.focus();
                } else {
                    this.options[0].focus();
                }
            }

            scrollToComfortablePosition() {
                // Aguarda o menu renderizar antes de fazer scroll
                setTimeout(() => {
                    const toggleRect = this.toggle.getBoundingClientRect();
                    const menuHeight = this.menu.offsetHeight;
                    const toggleHeight = this.toggle.offsetHeight;

                    // Calcula a posição ideal (dropdown deve ficar no meio/terço superior da tela)
                    const targetPosition = toggleRect.top + toggleHeight + (menuHeight / 2) - (window.innerHeight / 3);

                    // Faz scroll suave se necessário
                    if (targetPosition > 0) {
                        window.scrollBy({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                }, 50);
            }

            closeMenu() {
                this.menu.classList.remove('open');
                this.toggle.setAttribute('aria-expanded', 'false');
            }

            async selectOption(option) {
                this.currentValue = option.getAttribute('data-value');
                this.currentLabel = option.getAttribute('data-label');
                this.hiddenInput.value = this.currentValue;

                // Atualiza o label do botão, incluindo duração se houver
                let label = this.currentLabel;
                let duracaoStr = '';
                if (this.currentValue) {
                    const duracaoMin = await obterDuracaoServico(this.currentValue);
                    const horas = Math.floor(duracaoMin / 60);
                    const minutos = duracaoMin % 60;
                    if (horas >= 1) {
                        duracaoStr = ` (${horas.toString().padStart(2, '0')}h${minutos.toString().padStart(2, '0')}min)`;
                    } else {
                        duracaoStr = ` (${minutos.toString().padStart(2, '0')}min)`;
                    }
                }
                this.toggle.querySelector('.dropdown-label').textContent = label + duracaoStr;

                // Atualiza o estado de seleção
                this.options.forEach(opt => {
                    opt.removeAttribute('aria-selected');
                    opt.classList.remove('selected');
                });
                option.setAttribute('aria-selected', 'true');
                option.classList.add('selected');

                // Desabilita ou habilita "Selecione um serviço" conforme necessário
                const defaultOption = this.menu.querySelector('[data-value=""]');
                if (this.currentValue === '') {
                    // Se selecionou "Selecione um serviço", libera as outras opções
                    this.options.forEach(opt => {
                        opt.classList.remove('disabled');
                    });
                } else {
                    // Se selecionou uma opção válida, desabilita "Selecione um serviço"
                    if (defaultOption) {
                        defaultOption.classList.add('disabled');
                    }
                }

                // Invalida o cache de horários ocupados pois mudou o serviço
                if (typeof invalidarCacheHorariosOcupados === 'function') {
                    invalidarCacheHorariosOcupados();
                }

                // Se uma data já está selecionada, regenera os horários com a nova duração do serviço
                if (typeof seletorDatas !== 'undefined' && typeof seletorHorarios !== 'undefined' && seletorDatas && seletorDatas.dataSelecionada) {
                    const duracao = this.currentValue ? await obterDuracaoServico(this.currentValue) : 0;
                    console.log(`[SelectOption] Serviço alterado para "${this.currentValue}", duração: ${duracao}min, regenerando horários para ${seletorDatas.dataSelecionada}`);
                    seletorHorarios.gerarBadgesParaData(seletorDatas.dataSelecionada, duracao);
                }

                this.closeMenu();
                this.toggle.focus();
            }

            handleToggleKeydown(e) {
                if ((e.key === 'Enter' || e.key === ' ') && !this.menu.classList.contains('open')) {
                    e.preventDefault();
                    this.openMenu();
                } else if (e.key === 'ArrowDown' && !this.menu.classList.contains('open')) {
                    e.preventDefault();
                    this.openMenu();
                } else if (e.key === 'ArrowUp' && !this.menu.classList.contains('open')) {
                    e.preventDefault();
                    this.openMenu();
                }
            }

            handleKeydown(e, option) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (!option.classList.contains('disabled')) {
                        this.selectOption(option);
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextOption = option.nextElementSibling;
                    if (nextOption && nextOption.classList.contains('dropdown-option')) {
                        nextOption.focus();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevOption = option.previousElementSibling;
                    if (prevOption && prevOption.classList.contains('dropdown-option')) {
                        prevOption.focus();
                    }
                }
            }

            handleClickOutside(e) {
                if (!this.container.contains(e.target) && this.menu.classList.contains('open')) {
                    this.closeMenu();
                }
            }

            getValue() {
                return this.currentValue;
            }

            setValue(value) {
                const option = Array.from(this.options).find(opt => opt.getAttribute('data-value') === value);
                if (option) {
                    this.selectOption(option);
                }
            }
        }

        // Inicializa o dropdown de serviço
        const dropdownServico = new CustomDropdown('dropdownServico');

        // SELEÇÃO DE HORÁRIOS
        class SeletorHorarios {
            constructor(scrollContainerId, hiddenInputId) {
                this.scrollContainer = document.getElementById(scrollContainerId);
                this.hiddenInput = document.getElementById(hiddenInputId);
                this.horarioSelecionado = null;
                this.horariosDisponiveis = {};
                this.horariosOcupados = {};
                this.dataAtual = null;
            }

            async carregarHorarios() {
                try {
                    console.log('Iniciando carregamento de horários...');
                    // Verifica se as funções existem
                    if (typeof carregarHorariosDisponiveis === 'undefined' || typeof carregarHorariosOcupados === 'undefined') {
                        console.warn('Funções de carregamento de horários não estão disponíveis');
                        this.limparHorarios();
                        return;
                    }

                    // Carrega os horários disponíveis e ocupados do Supabase (em paralelo)
                    const [disponveis, ocupados] = await Promise.all([
                        carregarHorariosDisponiveis(),
                        carregarHorariosOcupados()
                    ]);

                    this.horariosDisponiveis = disponveis;
                    this.horariosOcupados = ocupados;
                    console.log('Horários disponíveis:', this.horariosDisponiveis);
                    console.log('Horários ocupados:', this.horariosOcupados);

                    if (Object.keys(this.horariosDisponiveis).length === 0) {
                        console.warn('Nenhum horário disponível');
                        this.limparHorarios();
                    }
                } catch (error) {
                    console.error('Erro ao carregar horários:', error);
                    this.limparHorarios();
                }
            }

            gerarBadgesParaData(data, duracao = 0) {
                this.dataAtual = data;
                const horarios = this.horariosDisponiveis[data];
                const horariosOcupadosNaData = this.horariosOcupados[data] || [];

                console.log(`\n=== Gerando badges para data: ${data} ===`);
                console.log(`  Serviço selecionado com duração: ${duracao} minutos`);
                console.log(`  Horários disponíveis:`, horarios);
                console.log(`  Horários ocupados bruto:`, this.horariosOcupados);
                console.log(`  Horários ocupados da data:`, horariosOcupadosNaData);

                // Limpa o container
                this.scrollContainer.innerHTML = '';

                if (!horarios || horarios.length === 0) {
                    this.scrollContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Nenhum horário disponível para este dia</p>';
                    this.horarioSelecionado = null;
                    this.hiddenInput.value = '';
                    return;
                }

                // Cria badges para cada horário
                horarios.forEach((horario) => {
                    const badge = document.createElement('button');
                    badge.type = 'button';
                    badge.className = 'horario-badge';
                    badge.setAttribute('data-horario', horario);
                    badge.textContent = horario;

                    // Verifica se o horário está dentro de um intervalo ocupado
                    let ocupado = false;

                    if (horariosOcupadosNaData && horariosOcupadosNaData.length > 0) {
                        const horarioMin = horarioParaMinutos(horario);
                        for (let intervalo of horariosOcupadosNaData) {
                            if (!intervalo || typeof intervalo !== 'string') {
                                continue;
                            }
                            const partes = intervalo.split('-');
                            if (partes.length !== 2) {
                                continue;
                            }
                            const [inicio, fim] = partes.map(h => horarioParaMinutos(h));
                            if (horarioMin >= inicio && horarioMin < fim) {
                                ocupado = true;
                                console.log(`  ${horario}: BLOQUEADO (dentro do intervalo ${intervalo})`);
                                break;
                            }
                        }
                    }

                    if (!ocupado) {
                        console.log(`  ${horario}: DISPONÍVEL`);
                        badge.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.selecionarHorario(badge);
                        });
                    } else {
                        badge.classList.add('ocupado');
                        badge.disabled = true;
                        badge.addEventListener('click', (e) => {
                            e.preventDefault();
                        });
                    }

                    this.scrollContainer.appendChild(badge);
                });

                // Desmarca qualquer horário anterior e limpa o valor
                this.horarioSelecionado = null;
                this.hiddenInput.value = '';
                console.log(`=== Fim geração de badges para ${data} ===\n`);
            }

            selecionarHorario(badge) {
                // Remove seleção anterior
                const badgeSelecionado = this.scrollContainer.querySelector('.horario-badge.selected');
                if (badgeSelecionado) {
                    badgeSelecionado.classList.remove('selected');
                }

                // Seleciona o novo badge
                badge.classList.add('selected');
                const horario = badge.getAttribute('data-horario');
                this.horarioSelecionado = horario;
                this.hiddenInput.value = horario;

                console.log(`Horário selecionado: ${horario}`);
            }

            limparHorarios() {
                this.scrollContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Selecione uma data para ver os horários disponíveis</p>';
                this.horarioSelecionado = null;
                this.hiddenInput.value = '';
            }

            getHorario() {
                return this.horarioSelecionado;
            }

            setHorario(horario) {
                const badge = this.scrollContainer.querySelector(`[data-horario="${horario}"]`);
                if (badge) {
                    this.selecionarHorario(badge);
                }
            }
        }

        // SELEÇÃO DE DATAS
        class SeletorDatas {
            constructor(scrollContainerId, hiddenInputId) {
                this.scrollContainer = document.getElementById(scrollContainerId);
                this.hiddenInput = document.getElementById(hiddenInputId);
                this.dataSelecionada = null;
                this.datasDisponiveis = [];
                this.init();
            }

            init() {
                this.carregarEGerarBadges();
            }

            async carregarEGerarBadges() {
                try {
                    console.log('Iniciando carregamento de datas...');
                    // Verifica se a função existe
                    if (typeof carregarDatasDisponiveis === 'undefined') {
                        console.warn('Função carregarDatasDisponiveis não está disponível, usando datas padrão');
                        this.gerarBadgesDatasPadrao();
                        return;
                    }

                    // Carrega as datas disponíveis do Supabase
                    this.datasDisponiveis = await carregarDatasDisponiveis();
                    console.log('Datas carregadas:', this.datasDisponiveis);

                    if (this.datasDisponiveis.length === 0) {
                        console.warn('Nenhuma data disponível, usando datas padrão');
                        this.gerarBadgesDatasPadrao();
                    } else {
                        this.gerarBadgesDatasCom(this.datasDisponiveis);
                    }
                } catch (error) {
                    console.error('Erro ao carregar datas:', error);
                    this.gerarBadgesDatasPadrao();
                }
            }

            gerarBadgesDatasPadrao() {
                const hoje = new Date();
                const diasDaSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
                const nomesMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                // Limpa o container
                this.scrollContainer.innerHTML = '';

                // Gera últimos 2 dias + próximos 14 dias
                for (let i = -2; i <= 14; i++) {
                    const data = new Date(hoje);
                    data.setDate(data.getDate() + i);

                    const dia = diasDaSemana[data.getDay()];
                    const numero = String(data.getDate()).padStart(2, '0');
                    const mes = nomesMeses[data.getMonth()];
                    const dataFormatada = data.toISOString().split('T')[0];

                    // Verifica se é data passada
                    const ehDataPassada = this.isDataPassada(dataFormatada);

                    const badge = document.createElement('button');
                    badge.type = 'button';
                    badge.className = 'data-badge';
                    if (ehDataPassada) {
                        badge.classList.add('passada');
                        badge.disabled = true;
                    }
                    badge.setAttribute('data-data', dataFormatada);

                    badge.innerHTML = `
                        <span class="data-badge-dia">${dia}</span>
                        <span class="data-badge-data">${numero}</span>
                        <span class="data-badge-mes">${mes}</span>
                    `;

                    badge.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (!ehDataPassada) {
                            this.selecionarData(badge);
                        }
                    });

                    this.scrollContainer.appendChild(badge);
                }
            }

            gerarBadgesDatasCom(datasDisponiveis) {
                const diasDaSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
                const nomesMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                // Limpa o container
                this.scrollContainer.innerHTML = '';
                console.log('Gerando badges com datas:', datasDisponiveis);

                let badgesGeradas = 0;

                // Cria badges para cada data disponível
                datasDisponiveis.forEach((dataStr, index) => {
                    try {
                        console.log(`Processando data ${index + 1}/${datasDisponiveis.length}: "${dataStr}"`);

                        // Remove espaços extras
                        dataStr = dataStr.trim();

                        let ano, mes, dia, dataFormatada;

                        // Verifica se é formato DD/MM/YYYY
                        if (dataStr.includes('/')) {
                            const dataParts = dataStr.split('/');
                            if (dataParts.length !== 3) {
                                console.warn(`Formato de data inválido: "${dataStr}", partes: ${dataParts.length}`);
                                return;
                            }

                            dia = parseInt(dataParts[0]);
                            mes = parseInt(dataParts[1]);
                            ano = parseInt(dataParts[2]);

                            // Formata para YYYY-MM-DD para armazenar
                            dataFormatada = `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                        }
                        // Verifica se é formato YYYY-MM-DD
                        else if (dataStr.includes('-')) {
                            const dataParts = dataStr.split('-');
                            if (dataParts.length !== 3) {
                                console.warn(`Formato de data inválido: "${dataStr}", partes: ${dataParts.length}`);
                                return;
                            }

                            ano = parseInt(dataParts[0]);
                            mes = parseInt(dataParts[1]);
                            dia = parseInt(dataParts[2]);
                            dataFormatada = dataStr;
                        }
                        else {
                            console.warn(`Formato de data não reconhecido: "${dataStr}"`);
                            return;
                        }

                        if (isNaN(ano) || isNaN(mes) || isNaN(dia)) {
                            console.warn(`Data com valores inválidos: ano=${ano}, mes=${mes}, dia=${dia}`);
                            return;
                        }

                        // Cria data usando os valores
                        const data = new Date(ano, mes - 1, dia);

                        // Verifica se é data passada
                        const ehDataPassada = this.isDataPassada(dataFormatada);

                        const diaSemana = diasDaSemana[data.getDay()];
                        const numeroData = String(data.getDate()).padStart(2, '0');
                        const nomeMes = nomesMeses[data.getMonth()];

                        const badge = document.createElement('button');
                        badge.type = 'button';
                        badge.className = 'data-badge';
                        if (ehDataPassada) {
                            badge.classList.add('passada');
                            badge.disabled = true;
                        }
                        badge.setAttribute('data-data', dataFormatada);

                        badge.innerHTML = `
                            <span class="data-badge-dia">${diaSemana}</span>
                            <span class="data-badge-data">${numeroData}</span>
                            <span class="data-badge-mes">${nomeMes}</span>
                        `;

                        badge.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (!ehDataPassada) {
                                this.selecionarData(badge);
                            }
                        });

                        this.scrollContainer.appendChild(badge);
                        badgesGeradas++;
                        console.log(`Badge gerado com sucesso: ${dataFormatada} (${diaSemana}, ${numeroData}/${nomeMes})${ehDataPassada ? ' [PASSADA]' : ''}`);
                    } catch (error) {
                        console.error(`Erro ao processar data ${dataStr}:`, error);
                    }
                });

                console.log(`Total de badges gerados: ${badgesGeradas}/${datasDisponiveis.length}`);
            }

            isDataPassada(dataFormatada) {
                // dataFormatada deve estar no formato YYYY-MM-DD
                const hoje = new Date();
                const hojeFormatada = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;

                // Comparação de string funciona para datas em YYYY-MM-DD
                return dataFormatada < hojeFormatada;
            }

            gerarBadgesDatas() {
                // Mantém por compatibilidade, mas agora usa carregarEGerarBadges
                this.carregarEGerarBadges();
            }

            selecionarData(badge) {
                // Verifica se o badge é uma data passada
                if (badge.classList.contains('passada') || badge.disabled) {
                    console.warn('Tentativa de selecionar data passada bloqueada');
                    return;
                }

                // Remove seleção anterior
                const badgeSelecionado = this.scrollContainer.querySelector('.data-badge.selected');
                if (badgeSelecionado) {
                    badgeSelecionado.classList.remove('selected');
                }

                // Seleciona o novo badge
                badge.classList.add('selected');
                const dataFormatada = badge.getAttribute('data-data');
                this.dataSelecionada = dataFormatada;
                this.hiddenInput.value = dataFormatada;

                // Mostra a seção de horários
                const horarioInput = document.getElementById('horarioAgendamento');
                if (horarioInput) {
                    horarioInput.classList.remove('hidden');
                }

                // Scroll suave para o badge selecionado
                badge.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

                // Gera badges de horários para a data selecionada com a duração do serviço
                if (typeof seletorHorarios !== 'undefined' && seletorHorarios) {
                    (async () => {
                        const servicoSelecionado = dropdownServico.getValue();
                        let duracao = 0;
                        if (servicoSelecionado) {
                            duracao = await obterDuracaoServico(servicoSelecionado);
                        }
                        seletorHorarios.gerarBadgesParaData(dataFormatada, duracao);
                    })();
                }
            }

            getData() {
                return this.dataSelecionada;
            }

            setData(data) {
                const badge = this.scrollContainer.querySelector(`[data-data="${data}"]`);
                if (badge) {
                    this.selecionarData(badge);
                }
            }
        }

        // Inicializa o seletor de datas - será feito dentro do DOMContentLoaded
        let seletorDatas;
        let seletorHorarios;

        // Função para carregar e popular os serviços com loader
        async function carregarEPopularServicos() {
            const loaderContainer = document.getElementById('loaderContainer');
            const loaderSpinner = loaderContainer.querySelector('.loader-spinner');
            const loaderError = loaderContainer.querySelector('.loader-error');

            // Garante que o loader está visível e mostra o spinner
            loaderContainer.classList.remove('hide');
            loaderSpinner.classList.remove('hidden');
            loaderError.classList.remove('show');

            try {
                // Cria promises para o fetch e para o timer mínimo
                const fetchPromise = carregarServicosDisponiveis();
                const timerPromise = new Promise(resolve => setTimeout(resolve, 500));

                // Espera ambos terminarem (fetch e 2 segundos)
                const servicos = await Promise.all([fetchPromise, timerPromise]).then(results => results[0]);

                if (servicos.length === 0) {
                    console.warn('Nenhum serviço disponível para carregar');
                    // Mostra tela de erro
                    loaderSpinner.classList.add('hidden');
                    loaderError.classList.add('show');
                    return;
                }

                // Obtém o menu do dropdown
                const dropdownMenu = document.getElementById('dropdownMenu');

                // Remove as opções antigas (mantém apenas "Selecione um serviço")
                const opcoes = dropdownMenu.querySelectorAll('.dropdown-option');
                opcoes.forEach(opcao => {
                    if (opcao.getAttribute('data-value') !== '') {
                        opcao.remove();
                    }
                });


                // Carrega as durações dos serviços e exibe ao lado do nome
                const duracoes = await carregarDuracoesServicos();
                servicos.forEach(servico => {
                    const li = document.createElement('li');
                    li.className = 'dropdown-option';
                    li.setAttribute('data-value', servico);
                    li.setAttribute('data-label', servico);

                    // Normaliza o nome do serviço para buscar a duração
                    const servicoNormalizado = servico
                        .toLowerCase()
                        .trim()
                        .replace(/[áàâãäéèêëíìîïóòôõöúùûüçÁÀÂÃÄÉÈÊËÍÌÎÏÓÒÔÕÖÚÙÛÜÇ]/g, function (char) {
                            const mapa = {
                                'á': 'a', 'à': 'a', 'â': 'a', 'ã': 'a', 'ä': 'a',
                                'é': 'e', 'è': 'e', 'ê': 'e', 'ë': 'e',
                                'í': 'i', 'ì': 'i', 'î': 'i', 'ï': 'i',
                                'ó': 'o', 'ò': 'o', 'ô': 'o', 'õ': 'o', 'ö': 'o',
                                'ú': 'u', 'ù': 'u', 'û': 'u', 'ü': 'u',
                                'ç': 'c'
                            };
                            return mapa[char] || char;
                        });
                    const duracaoMin = duracoes[servicoNormalizado] || 0;
                    const horas = Math.floor(duracaoMin / 60);
                    const minutos = duracaoMin % 60;
                    let duracaoStr = '';
                    if (horas >= 1) {
                        duracaoStr = ` (${horas.toString().padStart(2, '0')}h${minutos.toString().padStart(2, '0')}min)`;
                    } else {
                        duracaoStr = ` (${minutos.toString().padStart(2, '0')}min)`;
                    }
                    li.textContent = servico + duracaoStr;
                    dropdownMenu.appendChild(li);
                });

                // Reinicializa o dropdown com as novas opções
                dropdownServico.options = dropdownMenu.querySelectorAll('.dropdown-option');

                // Reaplica os event listeners apenas às NOVAS opções
                dropdownServico.options.forEach(option => {
                    // Remove listeners antigos (se existirem)
                    const clone = option.cloneNode(true);
                    option.parentNode.replaceChild(clone, option);
                });

                // Recarrega referência após limpar listeners
                dropdownServico.options = dropdownMenu.querySelectorAll('.dropdown-option');

                // Adiciona listeners para as opções
                dropdownServico.options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        if (!option.classList.contains('disabled')) {
                            dropdownServico.selectOption(option);
                        }
                        e.preventDefault();
                    });
                    option.addEventListener('keydown', (e) => dropdownServico.handleKeydown(e, option));
                });

                console.log('Serviços carregados e dropdown atualizado');
                // Esconde o loader após sucesso
                loaderContainer.classList.add('hide');
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
                // Mostra tela de erro
                loaderSpinner.classList.add('hidden');
                loaderError.classList.add('show');
            }
        }

        // Event listener do botão Tente novamente
        document.addEventListener('DOMContentLoaded', function () {
            const btnRetry = document.getElementById('btnRetry');
            if (btnRetry) {
                btnRetry.addEventListener('click', carregarEPopularServicos);
            }
            // Inicializa os seletores de datas e horários aqui, após todos os scripts serem carregados
            // Usa setTimeout para garantir que o supabase.js foi completamente carregado
            setTimeout(() => {
                seletorHorarios = new SeletorHorarios('horariosScroll', 'horarioAgendamento');
                seletorHorarios.carregarHorarios();
                seletorHorarios.limparHorarios();

                seletorDatas = new SeletorDatas('datasScroll', 'dataAgendamento');

                // Oculta a seção de horários inicialmente
                const horarioInput = document.getElementById('horarioAgendamento');
                if (horarioInput) {
                    horarioInput.classList.add('hidden');
                }
            }, 100);
        });

        // Carrega os serviços ao inicializar a página
        document.addEventListener('DOMContentLoaded', carregarEPopularServicos);

        // Caso o script seja carregado após o DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', carregarEPopularServicos);
        } else {
            carregarEPopularServicos();
        }

        // LÓGICA DE UI
        const btnVer = document.getElementById('verAgendamentos');
        const divLista = document.getElementById('listaAgendamentos');
        const overlay = document.getElementById('overlay');
        const conteudoLista = document.getElementById('agendamentosConteudo');
        const formulario = document.getElementById('formularioAgendamento');
        const telefonInput = document.getElementById('telefone');

        // Abre modal
        function abrirModal() {
            divLista.classList.add('active');
            overlay.classList.add('active');
            carregarMeusAgendamentos(conteudoLista);
        }

        // Fecha modal
        function fecharModal() {
            divLista.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Evento do botão de ver agendamentos
        btnVer.addEventListener('click', () => {
            if (divLista.classList.contains('active')) {
                fecharModal();
            } else {
                abrirModal();
            }
        });

        // Fechar ao clicar no overlay
        overlay.addEventListener('click', fecharModal);

        // Fechar ao clicar no botão X
        document.getElementById('btnFecharModal').addEventListener('click', fecharModal);

        // Formatação de telefone
        telefonInput.addEventListener('input', (e) => {
            let value = e.target.value;
            let numeros = value.replace(/\D/g, '');
            numeros = numeros.substring(0, 8);
            if (numeros.length >= 5) {
                value = numeros.substring(0, 4) + '-' + numeros.substring(4);
            } else {
                value = numeros;
            }
            e.target.value = value;
        });

        // Envio do formulário
        formulario.addEventListener('submit', async (e) => {
            e.preventDefault();

            const nome = document.getElementById('nome').value;
            const telefonComHifen = document.getElementById('telefone').value;
            const telefone = '(81)9' + telefonComHifen;
            const servico = dropdownServico.getValue();
            const data = seletorDatas.getData();
            const horario = seletorHorarios.getHorario();

            if (!servico) {
                alert('Por favor, selecione um serviço');
                return;
            }

            if (!data) {
                alert('Por favor, selecione uma data');
                return;
            }

            if (!horario) {
                alert('Por favor, selecione um horário');
                return;
            }

            // Obtém elementos do botão
            const btnAgendar = document.getElementById('btnAgendar');
            const spinner = btnAgendar.querySelector('.spinner-loader');
            const btnText = btnAgendar.querySelector('.btn-text');

            try {
                // Desabilita botão, mostra spinner e muda texto
                btnAgendar.disabled = true;
                spinner.classList.add('show');
                btnText.textContent = 'ENVIANDO';

                const novoId = await salvarNovoAgendamento(nome, telefone, servico, data, horario);
                alert(`Agendamento confirmado!\nID: ${novoId}\nHorário: ${horario}`);
                formulario.reset();
                dropdownServico.setValue('');
                seletorDatas.dataSelecionada = null;
                seletorDatas.hiddenInput.value = '';
                // Remove seleção visual de todas as datas
                seletorDatas.scrollContainer.querySelectorAll('.data-badge.selected').forEach(badge => {
                    badge.classList.remove('selected');
                });
                seletorHorarios.limparHorarios();

                // Oculta a seção de horários novamente
                const horarioInput = document.getElementById('horarioAgendamento');
                if (horarioInput) {
                    horarioInput.classList.add('hidden');
                }

                if (divLista.classList.contains('active')) {
                    carregarMeusAgendamentos(conteudoLista);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar: ' + error.message);
            } finally {
                // Restaura o estado do botão
                btnAgendar.disabled = false;
                spinner.classList.remove('show');
                btnText.textContent = 'AGENDAR';
            }
        });

        // Inicializa menu responsivo com melhorias (overlay, ESC, foco)
        (function () {
            const navToggle = document.querySelector('.nav-toggle');
            const navLinks = document.querySelector('.nav-links');
            const navOverlay = document.getElementById('nav-overlay');

            if (!navToggle || !navLinks) return;

            const links = Array.from(navLinks.querySelectorAll('a'));

            function openMenu() {
                navLinks.classList.add('open');
                navToggle.classList.add('open');
                navToggle.setAttribute('aria-expanded', 'true');
                if (navOverlay) {
                    navOverlay.classList.add('open');
                    navOverlay.setAttribute('aria-hidden', 'false');
                }
                // Fechar o modal de agendamentos quando abrir o menu
                fecharModal();
                document.body.classList.add('no-scroll');
                // foco no primeiro link para acessibilidade
                if (links[0]) links[0].focus();
                navToggle.setAttribute('aria-label', 'Fechar menu');
            }

            function closeMenu(returnFocus = true) {
                navLinks.classList.remove('open');
                navToggle.classList.remove('open');
                navToggle.setAttribute('aria-expanded', 'false');
                if (navOverlay) {
                    navOverlay.classList.remove('open');
                    navOverlay.setAttribute('aria-hidden', 'true');
                }
                document.body.classList.remove('no-scroll');
                if (returnFocus) navToggle.focus();
                navToggle.setAttribute('aria-label', 'Abrir menu');
            }

            navToggle.addEventListener('click', function (e) {
                e.stopPropagation();
                const opened = this.getAttribute('aria-expanded') === 'true';
                if (opened) closeMenu(); else openMenu();
            });

            // fechar ao clicar em overlay
            if (navOverlay) {
                navOverlay.addEventListener('click', () => closeMenu());
            }

            // fechar ao clicar em um link e remover rolagem
            links.forEach(a => {
                a.addEventListener('click', () => closeMenu(false));
            });

            // fechar com ESC e gerenciar trap de foco
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeMenu();
                }
            });

            // foco cíclico dentro do menu quando aberto
            navLinks.addEventListener('keydown', function (e) {
                if (e.key !== 'Tab') return;
                const first = links[0];
                const last = links[links.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            });

            // fechar se redimensionar para desktop
            window.addEventListener('resize', function () {
                if (window.innerWidth > 768 && navLinks.classList.contains('open')) {
                    closeMenu();
                }
            });
        })();

    </script>
</body>

</html>